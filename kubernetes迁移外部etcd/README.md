# K8S安装 Kubernetes 1.21.1 版本对接外部etcd集群


## 测试目的：
如果k8s的ETCD集群出现问题，可以将etcd集群部署在外部方便维护和恢复


## 环境准备：

etcd集群信息：
| 节点   | IP           | 配置 | 角色    |
| ------ | ------------ | ---- | ------- |
| etcd01 | 10.10.40.160 | 2C4G | master  |
| etcd02 | 10.10.40.161 | 2C4G | slave01 |
| etcd03 | 10.10.40.162 | 2C4G | slave02 |

k8s集群信息：
| 节点         | IP           | 配置 | 角色     |
| ------------ | ------------ | ---- | -------- |
| k8s-master01 | 10.10.40.151 | 8C8G | master01 |
| k8s-node01 | 10.10.40.152 | 8C8G | master02 |
| k8s-node02 | 10.10.40.153 | 8C8G | master03 |


## 安装步骤：

### 一、二进制安装外部ETCD集群

```
# 前期工具准备：
etcd-v3.4.3-linux-amd64.tar.gz    ##官网下载etcd安装包
cfssl                              ##cfssl自签证书工具
cfssljson     
```

#### 1、解压安装包
```
## 将安装包拷贝至etcd01-03节点的/root目录下进行解压
$ tar xf etcd-v3.4.3-linux-amd64.tar.gz   
$ cd etcd-v3.4.3-linux-amd64
$ chmod +x etcd etcdctl
$ $ cp etcd etcdctl /usr/bin   ##etcd命令设置成用户可执行命令

## 将自签证书工具拷贝至etcd01节点
$ mkdir /var/lib/etcd
$ useradd etcd
$ ls
cfssl  cfssljson
$ chmod +x cfssl cfssl-json
$ $ cp cfssl cfssl-json /usr/bin/   ##自签证书工具设置成用户可执行命令
```

#### 2、生成etcd证书
```
$ mkdir etcd-cert    ##创建存储证书目录
$ cd etcd-cert

## 配置生成 ca 证书的 json 文件
$ vi ca-config.json     
{
    "signing": {
        "default": {
            "expiry": "876000h"
        },
        "profiles": {
            "server": {
                "expiry": "876000h",
                "usages": [
                    "signing",
                    "key encipherment",
                    "server auth",
                    "client auth"
                ]
            },
            "client": {
                "expiry": "876000h",
                "usages": [
                    "signing",
                    "key encipherment",
                    "server auth",
                    "client auth"
                ]
            },
            "peer": {
                "expiry": "876000h",
                "usages": [
                    "signing",
                    "key encipherment",
                    "server auth",
                    "client auth"
                ]
            }
        }
    }
}

$ vi ca-csr.json
{
    "CN": "etcd ansible autogen CA",
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "O": "autogenerated",
            "OU": "etcd cluster",
            "L": "the internet"
        }
    ],
  "ca": {
    "expiry": "876000h"
  }
}

## 生成 ca 证书
$ cfssl gencert -initca ca-csr.json | cfssljson -bare ca -

##  配置生成 server 证书的 json 文件
$ vi server.json
{
    "CN": "Kubernetes",
    "hosts": [
        "10.10.40.160", ##etcd01_ip
        "10.10.40.161", ##etcd02_ip
        "10.10.40.162", ##etcd03_ip
        "127.0.0.1",    
        "::1",
        "::"
    ],
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "O": "autogenerated",
            "OU": "etcd cluster",
            "L": "the internet"
        }
    ]
}

$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server server.json | cfssljson -bare server

## 配置生成 client 证书的 json 文件
$ vi client.json    
{
    "CN": "Kubernetes",
    "hosts": [""],
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "O": "autogenerated",
            "OU": "etcd cluster",
            "L": "the internet"
        }
    ]


$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client client.json | cfssljson -bare client

## 配置生成 peer 证书的 json 文件
$ vi peer.json
{
    "CN": "Kubernetes",
    "hosts": [
        "10.10.40.160",   ##etcd01_ip
        "10.10.40.161",   ##etcd02_ip
        "10.10.40.162",   ##etcd03_ip
        "127.0.0.1",
        "::1",
        "::"
    ],
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "O": "autogenerated",
            "OU": "etcd cluster",
            "L": "the internet"
        }
    ]


$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer peer.json | cfssljson -bare peer

$ cd /opt/etcd-cert
$ ls
ca-config.json  ca-csr.json  ca.pem      client.json     client.pem  peer.json     peer.pem    server.json     server.pem
ca.csr          ca-key.pem   client.csr  client-key.pem  peer.csr    peer-key.pem  server.csr  server-key.pem
```

#### 3、创建etcd证书目录
```
## etcd01-03 节点都需要执行
$ mkdir -p /etc/etcd/ssl    
chown -R etcd:etcd /etc/etcd/ssl   ##给目录赋予属主属组

# etcd01 生成的证书文件拷贝至 /etc/etcd/ssl 目录下
$ cp -p ca.pem /etc/etcd/ssl
$ cp -p ca-key.pem /etc/etcd/ssl
$ cp -p server.pem /etc/etcd/ssl
$ cp -p server-key.pem /etc/etcd/ssl
$ cp -p client.pem /etc/etcd/ssl
$ cp -p client-key.pem /etc/etcd/ssl
$ cp -p peer.pem /etc/etcd/ssl
$ cp -p peer-key.pem /etc/etcd/ssl

$ cd /etc/etcd/ssl
$ ls
ca-key.pem  ca.pem  client-key.pem  client.pem  peer-key.pem  peer.pem  server-key.pem  server.pem
$ chomd 600 *        ##给文件增加权限
$ chown etcd:root *     ##给文件赋予属主属组 

# 将证书文件拷贝至 etcd01-03 节点中
$ scp * root@etcd02:/etc/etcd/ssl/     
$ scp * root@etcd03:/etc/etcd/ssl/
```

#### 4、配置etcd启动文件并启动
```
##  需要将IP地址改为对应服务器的地址 
## ETCD01:
$ vi /usr/lib/systemd/system/etcd.service
[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target
Documentation=https://github.com/coreos
[Service]
Type=notify
WorkingDirectory=/var/lib/etcd/
ExecStart=/usr/bin/etcd \
  --name etcd01 \      ## name 为节点主机名
  --cert-file=/etc/etcd/ssl/server.pem \
  --key-file=/etc/etcd/ssl/server-key.pem \
  --peer-cert-file=/etc/etcd/ssl/server.pem \
  --peer-key-file=/etc/etcd/ssl/server-key.pem \
  --trusted-ca-file=/etc/etcd/ssl/ca.pem \
  --peer-trusted-ca-file=/etc/etcd/ssl/ca.pem \
  --initial-advertise-peer-urls https://etcd-ip1:2380 \ ## etcd-ip1 为 node1 ip 以此类推，各节点需以自己节点 ip 为地址
  --listen-peer-urls https://etcd-ip1:2380 \
  --listen-client-urls https://etcd-ip1:2379,http://127.0.0.1:2379 \
  --advertise-client-urls https://etcd-ip1:2379 \
  --initial-cluster-token etcd-cluster-0 \
  --initial-cluster etcd01=https://etcd-ip1:2380,etcd02=https://etcd-ip2:2380,etcd03=https://etcd-ip3:2380 \
  --initial-cluster-state new \
  --data-dir=/var/lib/etcd
Restart=on-failure
RestartSec=5
LimitNOFILE=65536
 
[Install]
WantedBy=multi-user.target

## 所有节点启动ectd服务
$ systemctl daemon-reload
$ systemctl enable etcd
$ systemctl start etcd
$ systemctl status etcd
```

#### 5、检查集群状态
```
# 检查etcd集群状态
$ export ETCDCTL_API=3
$ etcdctl --endpoints=https://etcd-ip1:2379,https://etcd-ip1:2379,https://etcd-ip1:2379 --cert=/etc/etcd/ssl/client.pem --key=/etc/etcd/ssl/client-key.pem --cacert=/etc/etcd/ssl/ca.pem --write-out=table endpoint status
+---------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
|         ENDPOINT          |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |
+---------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
| https://10.10.40.160:2379 | 9a4507eb95ea4952 |   3.4.3 |   15 MB |     false |      false |        38 |     482063 |             482063 |        |
| https://10.10.40.161:2379 | c31f81687668b9bd |   3.4.3 |   15 MB |      true |      false |        38 |     482063 |             482063 |        |
| https://10.10.40.162:2379 | d5ae8473aa406931 |   3.4.3 |   15 MB |     false |      false |        38 |     482063 |             482063 |        |
+---------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+

```

### 二、备份/恢复k8s集群etcd数据
#### 1、备份
##### K8S集群 etcd 备份
```
## K8S集群 etcd 备份数据到 /opt/etcd-backup/ 目录下
## 单节点操作

$ mkdir /opt/etcd-backup    ##创建备份数据目录
$ export ETCDCTL_API=3
$ etcdctl --endpoints=https://127.0.0.1:2379 --cert=/etc/etcd/ssl/client.pem --key=/etc/etcd/ssl/client-key.pem --cacert=/etc/etcd/ssl/ca.pem  snapshot save /opt/etcd-backup/etcd-backup.db
```

#### 2、迁移
##### 将旧 etcd 的备份数据拷贝至新 etcd 集群中的所有节点上，还原数据
```
## 拷贝至各新 etcd 节点
$ scp /opt/etcd-backup root@etcd01:/opt/

## etcd01:
## https://10.10.40.160:2380 为本机 ip
$ cd /opt
$ etcdctl snapshot restore etcd-backup.db --name etcd01 --initial-cluster "etcd01=https://10.10.40.160:2380,etcd02=https://10.10.40.161:2380,etcd03=https://10.10.40.162:2380" --initial-advertise-peer-urls https://10.10.40.160:2380

# 执行成功后会在 etcd01-03 节点的 /opt 目录下生成对应的备份数据目录
$ ls
etcd01.etcd  etcd-backup.db
```

##### 将还原的数据文件放置 etcd 的数据目录中
```
## etcd01-03 都需执行
## 关闭 etcd，还原迁移数据
$ systemctl stop etcd

$ cd /var/lib/etcd/
$ mv member/ member.bak    ##将原有的数据进行拷贝，不然会覆盖失败

$ mv etcd01.etcd/member/ /var/lib/etcd/    ##将对应节点上的member文件夹拷贝到/var/lib/etcd/文件夹中

## 重启后检查 etcd 集群状态
$etcdctl --endpoints=https://etcd01:2379,https://etcd02:2379,https://etcd03:2379 --cert=/etc/etcd/ssl/client.pem --key=/etc/etcd/ssl/client-key.pem --cacert=/etc/etcd/ssl/ca.pem --write-out=table endpoint status
```
##### 将 etcd 集群的证书文件拷贝至 K8s 集群中进行替换
```
## 登陆至 etcd01 节点中将证书文件拷贝至 K8s 集群中
$ cd /etc/etcd/
$ scp ssl -r root@k8s01:/etc/etcd/ssl-new


## 切换至K8s集群中，备份证书与更换
$ cd /etc/etcd/
$ mv ssl ssl-bak
$ mv ssl-new ssl-bak
```

##### 更换 k8s 集群的 etcd 信息，重启 k8s 服务
```
## 修改 kube-apiserver.yaml 中的 etcd 地址，更换为 etcd 集群的 IP
$ vi kube-apiserver.yaml
...
    - '--etcd-servers=https://10.10.40.151:2379,https://10.10.40.152:2379,https://10.10.40.153:2379'    ##地址更换为 etcd 集群 IP 
...
## 移出 etcd 静态 pod 文件

## 重启 kubelet
```
